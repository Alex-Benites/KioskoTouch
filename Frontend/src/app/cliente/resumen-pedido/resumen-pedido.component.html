<div class="resumen-page-container">

  <app-publicidad-section
    seccion="pago"
    altura="200px"
    (publicidadCambio)="onPublicidadCambio($event)">
  </app-publicidad-section>

  <main class="resumen-content">

    <img src="assets/cliente/kiosko_go4k.png" alt="Kiosko Go!" class="kiosko-logo">

    <h1 class="resumen-title">Resumen del Pedido</h1>

    <div class="resumen-card">

      <div *ngIf="productosCarrito.length > 0; else sinProductos" class="productos-lista">
        <div
          *ngFor="let item of productosCarrito; let i = index"
          class="producto-item">

          <div class="producto-imagen">
            <img
              [src]="obtenerImagenProducto(item)"
              [alt]="obtenerNombreProducto(item)"
              class="producto-img">
          </div>

          <div class="producto-info">
            <h3 class="producto-nombre">{{ obtenerNombreProducto(item) }}</h3>
            <p class="producto-precio">${{ item.subtotal | number:'1.2-2' }}</p>
          </div>
        </div>
      </div>

      <ng-template #sinProductos>
        <div class="sin-productos">
          <p>No hay productos en el pedido</p>
          <button class="link-button" (click)="irAlMenu()">Ir al Menú</button>
        </div>
      </ng-template>

      <div class="separador"></div>

      <div class="totales-section">
        <div class="totales-container">

          <div class="total-item">
            <span class="total-label">Subtotal</span>
            @if (cargandoIva) {
              <span class="total-valor loading">Calculando...</span>
            } @else {
              <span class="total-valor">${{ calcularSubtotal() | number:'1.2-2' }}</span>
            }
          </div>

          <div class="total-item">
            <span class="total-label">IVA {{ ivaActual | number:'1.0-0' }}%</span>
            @if (cargandoIva) {
              <span class="total-valor loading">Calculando...</span>
            } @else {
              <span class="total-valor">${{ calcularIVA() | number:'1.2-2' }}</span>
            }
          </div>

          <div class="total-item total-final">
            <span class="total-label">Total</span>
            @if (cargandoIva) {
              <span class="total-valor loading">Calculando...</span>
            } @else {
              <span class="total-valor">${{ calcularTotal() | number:'1.2-2' }}</span>
            }
          </div>

        </div>
      </div>
    </div>

    <div class="metodos-pago">
      <h2 class="metodos-title">Métodos de Pago</h2>

      <div class="pago-opciones">
        <div class="pago-opcion" [class.selected]="metodoPagoSeleccionado === 'tarjeta'" (click)="seleccionarMetodoPago('tarjeta')">
          <div class="pago-icon">
            <img src="assets/cliente/USUARIO_84.png" alt="Tarjeta">
          </div>
          <span class="pago-texto">Tarjeta</span>
          <div class="check-icon" *ngIf="metodoPagoSeleccionado === 'tarjeta'">✓</div>
        </div>

        <div class="pago-opcion" [class.selected]="metodoPagoSeleccionado === 'efectivo'" (click)="seleccionarMetodoPago('efectivo')">
          <div class="pago-icon">
            <img src="assets/cliente/USUARIO_85.png" alt="Efectivo">
          </div>
          <span class="pago-texto">Efectivo</span>
          <div class="check-icon" *ngIf="metodoPagoSeleccionado === 'efectivo'">✓</div>
        </div>
      </div>
    </div>

    <div class="datos-facturacion">
      <div class="checkbox-container">
        <input
          type="checkbox"
          id="facturacion-checkbox"
          [(ngModel)]="mostrarDatosFacturacion"
          class="facturacion-checkbox">
        <label for="facturacion-checkbox" class="checkbox-label">
          <span class="checkbox-custom"></span>
          Datos de Facturación
        </label>
      </div>

      <div class="datos-form" *ngIf="mostrarDatosFacturacion">
        <div class="form-row">
          <div class="form-group">
            <label for="nombre-completo">Nombre Completo *</label>
            <input
              type="text"
              id="nombre-completo"
              [(ngModel)]="datosFacturacion.nombreCompleto"
              placeholder="Ingresa tu nombre completo"
              class="form-input"
              [class.error]="erroresValidacion.nombreCompleto"
              required>
            <span class="error-message" *ngIf="erroresValidacion.nombreCompleto">
              {{ erroresValidacion.nombreCompleto }}
            </span>
          </div>

          <div class="form-group">
            <label for="cedula">Cédula *</label>
            <input
              type="text"
              id="cedula"
              [(ngModel)]="datosFacturacion.cedula"
              placeholder="Ingresa tu cédula"
              class="form-input"
              [class.error]="erroresValidacion.cedula"
              required>
            <span class="error-message" *ngIf="erroresValidacion.cedula">
              {{ erroresValidacion.cedula }}
            </span>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="telefono">Teléfono</label>
            <input
              type="tel"
              id="telefono"
              [(ngModel)]="datosFacturacion.telefono"
              placeholder="Ingresa tu teléfono"
              class="form-input">
          </div>

          <div class="form-group">
            <label for="correo">Correo Electrónico *</label>
            <input
              type="email"
              id="correo"
              [(ngModel)]="datosFacturacion.correo"
              placeholder="Ingresa tu correo"
              class="form-input"
              [class.error]="erroresValidacion.correo"
              required>
            <span class="error-message" *ngIf="erroresValidacion.correo">
              {{ erroresValidacion.correo }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <div class="turno-info" *ngIf="tieneTurno">
      <div class="turno-display">
        <i class="fas fa-ticket-alt"></i>
        <span class="turno-label">Tu Turno:</span>
        <span class="turno-numero">{{ numeroTurno }}</span>
      </div>
    </div>

    <div class="botones-accion">
      <div class="botones-fila">
        <button
          class="secondary-button cancel-btn"
          (click)="cancelarPedido()">
          <mat-icon>cancel</mat-icon>
          Cancelar Pedido
        </button>

        <button
          class="tertiary-button edit-btn"
          (click)="editarPedido()">
          <mat-icon>edit</mat-icon>
          Editar Pedido
        </button>
      </div>

      <button
        class="primary-button confirm-btn"
        (click)="confirmarPedido()"
        [disabled]="cantidadProductos === 0 || !metodoPagoSeleccionado">
        <mat-icon>arrow_forward</mat-icon>
        Continuar
      </button>
    </div>

  </main>
</div>
