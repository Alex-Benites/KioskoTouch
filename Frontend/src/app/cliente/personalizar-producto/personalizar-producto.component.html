<div class="personalizar-page-container">
  <app-publicidad-section
    seccion="carrito"
    altura="200px"
    (publicidadCambio)="onPublicidadCambio($event)">
  </app-publicidad-section>

  <header class="menu-header">
    <img src="assets/cliente/USUARIO_6.png" alt="Kiosko Go">
  </header>

  <main class="personalizacion-content">
    <div class="producto-container-centrado">
      <div class="producto-detalle">
        <div class="producto-imagen">
          <img [src]="imagenProducto" [alt]="nombreProducto" class="imagen-principal">
        </div>

        <div class="producto-info">
          <p class="categoria-label">MEN√ö {{ nombreCategoria.toUpperCase() }}</p>

          <h1 class="producto-nombre">{{ nombreProducto }}</h1>

          <p class="producto-descripcion">{{ descripcionProducto }}</p>

          <div class="precio-cantidad-horizontal">
            <div class="precio-seccion">
              <span class="precio-unitario">${{ precioProducto.toFixed(2) }}</span>
            </div>

            <div class="cantidad-accion-container">
              <div class="cantidad-control">
                <button
                  class="cantidad-btn disminuir"
                  (click)="disminuirCantidad()"
                  [disabled]="cantidad() <= 1">
                  -
                </button>
                <span class="cantidad-numero">{{ cantidad() }}</span>
                <button
                  class="cantidad-btn aumentar"
                  (click)="aumentarCantidad()">
                  +
                </button>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="ingredientes-container">
      <div class="ingredientes-seccion">
        <h2 class="ingredientes-titulo">Ingredientes</h2>
        <div class="ingredientes-separador"></div>

        <div *ngIf="mostrandoCarga()" class="ingredientes-loading">
          <div class="loading-spinner">‚è≥</div>
          <p>Cargando opciones de personalizaci√≥n...</p>
        </div>

        <div *ngIf="ingredientesCargados() && !tieneIngredientesPersonalizables()" class="sin-ingredientes-message">
          <div class="message-icon">‚ÑπÔ∏è</div>
          <p class="message-text">{{ mensajeSinIngredientes() }}</p>
          <p class="message-subtext">Este producto se agregar√° al carrito con su preparaci√≥n est√°ndar.</p>
        </div>

        <div *ngIf="ingredientesCargados() && tieneIngredientesPersonalizables()" class="ingredientes-section">
          <h3 class="section-title">ü•ó Personaliza tus ingredientes</h3>
          <p class="section-subtitle">Agrega o quita ingredientes seg√∫n tu preferencia</p>
 
          <div class="ingredientes-grid">
            <div
                class="ingrediente-card"
                *ngFor="let ingrediente of ingredientesDisponibles()"
                [class.seleccionado]="ingrediente.cantidad > 0">

              <div class="ingrediente-imagen">
                <img [src]="ingrediente.imagenUrl" [alt]="ingrediente.nombre">
              </div>

              <div class="ingrediente-info">
                <h4 class="ingrediente-nombre">{{ ingrediente.nombre }}</h4>
                <p class="ingrediente-precio">
                  <span *ngIf="ingrediente.esOriginal" class="precio-incluido">
                    <span *ngIf="ingrediente.cantidad === 0" class="sin-ingrediente">
                      Sin {{ ingrediente.nombre.toLowerCase() }}
                    </span>
                    <span *ngIf="ingrediente.cantidad === 1" class="incluido-normal">
                      Incluido
                    </span>
                    <span *ngIf="ingrediente.cantidad > 1" class="incluido-con-extra">
                      Incluido + {{ ingrediente.cantidad - 1 }} extra
                      <span class="costo-extra">(+${{ calcularCostoExtraConIva(ingrediente).toFixed(2) }})</span>
                    </span>
                  </span>

                  <span *ngIf="!ingrediente.esOriginal" class="precio-adicional">
                    <span *ngIf="ingrediente.cantidad === 0" class="no-seleccionado">
                      +${{ calcularPrecioIngredienteConIva(ingrediente).toFixed(2) }} c/u
                    </span>
                    <span *ngIf="ingrediente.cantidad > 0" class="seleccionado-adicional">
                      {{ ingrediente.cantidad }} x ${{ calcularPrecioIngredienteConIva(ingrediente).toFixed(2) }} =
                      <span class="total-ingrediente">+${{ calcularCostoExtraConIva(ingrediente).toFixed(2) }}</span>
                    </span>
                  </span>
                </p>
              </div>

              <div class="ingrediente-controles">
                <button
                  class="control-btn disminuir"
                  (click)="disminuirIngrediente(ingrediente)"
                  [disabled]="ingrediente.esOriginal ? ingrediente.cantidad <= 1 : ingrediente.cantidad <= 0"
                  [title]="obtenerTooltipDisminuir(ingrediente)">
                  -
                </button>

                <span class="cantidad-ingrediente">{{ ingrediente.cantidad }}</span>

                <button
                  class="control-btn aumentar"
                  (click)="aumentarIngrediente(ingrediente)"
                  title="Agregar m√°s {{ ingrediente.nombre }}">
                  +
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="order-summary-footer" *ngIf="!modoEdicion">
    <div class="order-summary-header">
      <h2>üõí Mi Orden</h2>
      <span class="badge-items" *ngIf="pedidoService.cantidadItems() > 0">
        {{ pedidoService.cantidadItems() }}
      </span>
    </div>

    <div class="order-summary-content">
      <div class="precio-actual">
        <span class="precio-label">Este producto:</span>
        <span class="precio-valor">${{ precioTotalCalculado().toFixed(2) }}</span>
      </div>

      <div class="total-pedido" *ngIf="pedidoService.cantidadItems() > 0">
        <span class="total-label">Total del pedido:</span>
        <span class="total-valor">${{ pedidoService.total().toFixed(2) }}</span>
      </div>
    </div>

    <div class="action-buttons">
      <button class="btn-secundario" (click)="volverAlMenu()">
        <i class="material-icons">restaurant_menu</i>
        Seguir Comprando
      </button>

      <button class="btn-principal"
        (click)="confirmarPersonalizacion()"
        [disabled]="procesandoConfirmacion || !hayAlMenosUnIngredienteSeleccionado()">
        <i class="material-icons" *ngIf="!procesandoConfirmacion">add_shopping_cart</i>
        <i class="material-icons spin" *ngIf="procesandoConfirmacion">refresh</i>
        <span *ngIf="!procesandoConfirmacion">A√±adir ${{ precioTotalCalculado().toFixed(2) }}</span>
        <span *ngIf="procesandoConfirmacion">Agregando...</span>
      </button>
    </div>
  </footer>

  <div class="edit-actions-bar" *ngIf="modoEdicion">
    <button class="btn-volver" (click)="volverAlCarrito()">
      <i class="material-icons">arrow_back</i>
      Volver al Carrito
    </button>

    <div class="precio-display">
      ${{ precioTotalCalculado().toFixed(2) }}
    </div>

    <button class="btn-actualizar"
        (click)="confirmarPersonalizacion()"
        [disabled]="procesandoConfirmacion || !hayAlMenosUnIngredienteSeleccionado()">
      <i class="material-icons" *ngIf="!procesandoConfirmacion">update</i>
      <i class="material-icons spin" *ngIf="procesandoConfirmacion">refresh</i>
      <span *ngIf="!procesandoConfirmacion">Actualizar</span>
      <span *ngIf="procesandoConfirmacion">Actualizando...</span>
    </button>
  </div>


</div>

