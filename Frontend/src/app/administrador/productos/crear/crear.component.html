<app-header-admin></app-header-admin>

<div class="form-container">

  <p class="breadcrumb-title">GESTIÓN DE PRODUCTOS</p>
  <h1 class="form-main-title">
    {{ isEditMode ? 'Editar Producto' : 'Creación de nuevo Producto' }}
  </h1>

  <form [formGroup]="productoForm" (ngSubmit)="onSubmit()" class="product-form">
    <div class="form-grid">
      <div class="form-fields-column">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Nombre del producto</mat-label>
          <input matInput formControlName="nombre" placeholder="Ej: Hamburguesa Clásica">
          @if (productoForm.get('nombre')?.hasError('required')) {
          <mat-error *ngIf="nombreError">{{ nombreError }}</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Descripción del producto</mat-label>
          <textarea matInput formControlName="descripcion" placeholder="Ej: Deliciosa carne con queso cheddar..."
            rows="3"></textarea>
          @if (productoForm.get('descripcion')?.hasError('required')) {
          <mat-error *ngIf="descripcionError">{{ descripcionError }}</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Categoría</mat-label>
          <mat-select formControlName="categoria" (selectionChange)="onCategoriaSeleccionada($event)">
            @for (cat of categorias; track cat.id) {
            <mat-option [value]="cat.id">{{cat.nombre}}</mat-option>
            }
          </mat-select>
          @if (productoForm.get('categoria')?.hasError('required')) {
          <mat-error *ngIf="categoriaError">{{ categoriaError }}</mat-error>
          }
        </mat-form-field>

        <!-- Modificar el campo de precio para mostrar un estado diferente cuando está deshabilitado -->

        <mat-form-field appearance="outline" class="form-field" 
                       [class.precio-deshabilitado]="productoForm.get('aplicaTamanos')?.value">
          <mat-label>{{ productoForm.get('aplicaTamanos')?.value ? 'Precio base (deshabilitado)' : 'Precio del producto' }}</mat-label>
          <input matInput type="number" formControlName="precio" placeholder="Ej: 9.99">
          <mat-error *ngIf="precioError">{{ precioError }}</mat-error>
          <mat-hint *ngIf="productoForm.get('aplicaTamanos')?.value">
            Los precios se definirán por tamaño
          </mat-hint>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Disponibilidad</mat-label>
          <mat-select formControlName="disponibilidad">
            @for (disp of estados; track disp.id) {
            <mat-option [value]="disp.id">{{disp.nombre}}</mat-option>
            }
          </mat-select>
          @if (productoForm.get('disponibilidad')?.hasError('required')) {
          <mat-error *ngIf="disponibilidadError">{{ disponibilidadError }}</mat-error>
          }
        </mat-form-field>
      </div>

      <div class="image-upload-column">
        <p class="image-upload-label">Imagen del producto</p>
        <div class="image-upload-container" (click)="fileInput.click()">
          <input hidden type="file" #fileInput id="fileInput" (change)="onFileSelected($event)"
            accept="image/png, image/jpeg, image/gif">
          @if (!imagePreview) {
          <img src="assets/admin/ADMIN_27.png" alt="Subir Imagen Icono" class="upload-placeholder-icon">
          <p>Formato de imagen 90x90</p>
          } @else {
          <img [src]="imagePreview" alt="Vista previa de la imagen" class="image-preview">
          }
        </div>
        @if (imagePreview) {
        <button (click)="eliminarImagen()" class="primary__button delete-image-button" type="button">
          Eliminar
        </button>
        }
      </div>
    </div> 

    <!-- Nueva sección de tamaños -->
    <div class="tamanos-section">
      <h2>Opciones de Tamaño</h2>
      
      <div class="tamanos-toggle">
        <mat-checkbox formControlName="aplicaTamanos">
          Este producto tiene diferentes tamaños con precios distintos
        </mat-checkbox>
      </div>

      @if (productoForm.get('aplicaTamanos')?.value) {
      <div class="tamanos-grid">
        @for (tamano of tamanos; track tamano.id) {
        <div class="tamano-card">
          <div class="tamano-info">
            <span class="tamano-nombre">{{ tamano.nombre }}</span>
            <mat-form-field appearance="outline" class="tamano-precio-field">
              <mat-label>Precio {{ tamano.nombre }}</mat-label>
              <input matInput type="number" [formControlName]="'precio_' + tamano.codigo.toLowerCase()" 
                     placeholder="0.00" step="0.01">
              <span matPrefix>$</span>
            </mat-form-field>
          </div>
        </div>
        }
      </div>
      }
    </div>

    <!-- Sección de Ingredientes -->
    <div class="ingredientes-section">
      <h2>Ingredientes Disponibles</h2>
      @if (ingredientesDisponibles.length > 0) {
      <div class="ingredientes-grid">
        @for (ingrediente of ingredientesDisponibles; track ingrediente.id) {
        <div class="ingrediente-card"
             [class.selected]="ingrediente.cantidad > 0">
          
          <!-- ✅ QUITAR CHECKBOX Y AGREGAR INFORMACIÓN DEL INGREDIENTE -->
          <div class="ingrediente-content">
            <div class="ingrediente-image">
              <img [src]="getFullImageUrl(ingrediente.imagen_url)"
                   [alt]="ingrediente.nombre"
                   onerror="this.src='assets/images/no-ingredient.png'">
            </div>
            <div class="ingrediente-info">
              <span class="ingrediente-nombre">{{ ingrediente.nombre }}</span>
              @if (ingrediente.precio_adicional > 0) {
              <span class="ingrediente-precio">+${{ ingrediente.precio_adicional }}</span>
              }
            </div>
          </div>

          <!-- ✅ NUEVO: Contador de cantidad -->
          <div class="cantidad-controls">
            <button type="button" 
                    class="cantidad-btn cantidad-btn-minus"
                    [disabled]="ingrediente.cantidad <= 0"
                    (click)="disminuirCantidad(ingrediente)">
              -
            </button>
            
            <span class="cantidad-display">{{ ingrediente.cantidad || 0 }}</span>
            
            <button type="button" 
                    class="cantidad-btn cantidad-btn-plus"
                    (click)="aumentarCantidad(ingrediente)">
              +
            </button>
          </div>
        </div>
        }
      </div>
      } @else {
      <div class="no-ingredientes">
        <p>Esta categoría no tiene ingredientes disponibles</p>
      </div>
      }
    </div>

    <div class="form-actions">
      <button type="submit" class="primary__button" [disabled]="!productoForm.valid">{{ isEditMode ? 'Actualizar Producto' : 'Crear Producto' }}</button>
    </div>
  </form>
</div>

<app-footer-admin [backRoute]="'/administrador/gestion-productos'"></app-footer-admin>