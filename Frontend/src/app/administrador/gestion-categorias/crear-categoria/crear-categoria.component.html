<app-header-admin></app-header-admin>

<div class="form-container">
  <!-- ✅ Breadcrumb y título principal -->
  <p class="breadcrumb-title">GESTIÓN DE CATEGORÍAS</p>
  <h1 class="form-main-title">
    {{ isEditMode ? 'Editar Categoría' : 'Creación de nueva Categoría' }}
  </h1>

  <!-- ✅ Loading mejorado -->
  @if (loading && isEditMode) {
    <div class="loading-container">
      <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Cargando categoría...</p>
      </div>
    </div>
  }

  <!-- ✅ Error mejorado -->
  @if (error) {
    <div class="error-alert">
      <i class="fas fa-exclamation-triangle"></i>
      <span>{{ error }}</span>
    </div>
  }

  <!-- ✅ Formulario con layout vertical centrado -->
  @if (!loading || !isEditMode) {
    <form [formGroup]="categoriaForm" (ngSubmit)="guardarCategoria()" class="categoria-form">
      
      <div class="form-content">
        <!-- ✅ Campo Nombre -->
        <div class="form-field">
          <label for="nombre" class="form-label">
            <i class="fas fa-tag"></i>
            Nombre de la Categoría *
          </label>
          <input
            type="text"
            id="nombre"
            formControlName="nombre"
            class="form-control"
            [class.is-invalid]="isFieldInvalid('nombre')"
            placeholder="Ej: Hamburguesas, Bebidas, Postres..."
            maxlength="50">
          
          @if (isFieldInvalid('nombre')) {
            <div class="invalid-feedback">
              @if (categoriaForm.get('nombre')?.hasError('required')) {
                El nombre de la categoría es obligatorio
              }
              @if (categoriaForm.get('nombre')?.hasError('minlength')) {
                El nombre debe tener al menos 3 caracteres
              }
              @if (categoriaForm.get('nombre')?.hasError('maxlength')) {
                El nombre no puede exceder 50 caracteres
              }
            </div>
          }
          
          <small class="form-text">
            {{ categoriaForm.get('nombre')?.value?.length || 0 }}/50 caracteres
          </small>
        </div>

        <!-- ✅ Campo Imagen -->
        <div class="form-field">
          <label class="form-label">
            <i class="fas fa-image"></i>
            Imagen de la Categoría
          </label>
          
          <div class="image-upload-container" (click)="fileInput.click()">
            <input hidden type="file" #fileInput id="fileInput" 
                   (change)="onImagenSeleccionada($event)"
                   accept="image/png,image/jpeg,image/jpg,image/webp">
            
            @if (!imagenPreview && !imagenActual) {
              <img src="assets/admin/ADMIN_27.png" alt="Subir Imagen Icono" class="upload-placeholder-icon">
              <p>Formato de imagen recomendado 300x300</p>
            } @else {
              @if (imagenPreview) {
                <img [src]="imagenPreview" alt="Vista previa de la imagen" class="image-preview">
              } @else if (imagenActual) {
                <img [src]="imagenActual" alt="Imagen actual" class="image-preview">
              }
            }
          </div>
          
          <!-- ✅ Mensaje de error para imagen -->
          @if (!imagenPreview && !imagenActual && !isEditMode) {
            <div class="image-error-message">
              <i class="fas fa-exclamation-triangle error-icon"></i>
              <span>Es recomendable seleccionar una imagen para la categoría</span>
            </div>
          }
          
          @if (imagenPreview || imagenActual) {
            <button (click)="quitarImagen()" class="primary__button delete-image-button" type="button">
              <i class="fas fa-trash"></i>
              Quitar Imagen
            </button>
          }
          
          <small class="form-text">
            Formatos soportados: JPG, PNG, WEBP. Tamaño máximo: 5MB
          </small>
        </div>
      </div>

      <!-- ✅ Botones de acción -->
      <div class="form-actions">
        <button 
          type="button" 
          class="btn btn-outline-secondary"
          (click)="cancelar()"
          [disabled]="loading">
          <i class="fas fa-times"></i>
          Cancelar
        </button>

        <button 
          type="submit" 
          class="primary__button"
          [disabled]="loading || categoriaForm.invalid">
          <i class="fas" [class.fa-spinner]="loading" [class.fa-spin]="loading" 
             [class.fa-save]="!loading"></i>
          {{ isEditMode ? 'Actualizar Categoría' : 'Crear Categoría' }}
        </button>
      </div>
    </form>

    <!-- ✅ Panel de información -->
    <div class="info-panel">
      <div class="info-header">
        <i class="fas fa-info-circle"></i>
        <h4>Información</h4>
      </div>
      <div class="info-content">
        <div class="info-item">
          <i class="fas fa-check-circle"></i>
          <span>El nombre de la categoría debe ser único</span>
        </div>
        <div class="info-item">
          <i class="fas fa-image"></i>
          <span>La imagen es opcional pero recomendada</span>
        </div>
        <div class="info-item">
          <i class="fas fa-expand-arrows-alt"></i>
          <span>Se recomienda usar imágenes cuadradas (1:1)</span>
        </div>
        @if (isEditMode) {
          <div class="info-item">
            <i class="fas fa-link"></i>
            <span>Los productos asociados mantendrán su categoría</span>
          </div>
        }
      </div>
    </div>
  }

  <!-- ✅ Mensaje de éxito/error -->
  @if (mensaje) {
    <div class="mensaje-container" [ngClass]="'mensaje-' + tipoMensaje">
      <div class="mensaje-content">
        <i class="material-icons mensaje-icon">
          {{ getMensajeIcon() }}
        </i>
        <span class="mensaje-texto">{{ mensaje }}</span>
        <button class="btn-cerrar-mensaje" (click)="ocultarMensaje()">
          <i class="material-icons">close</i>
        </button>
      </div>
    </div>
  }
</div>

<app-footer-admin [backRoute]="'/administrador/gestion-categorias'"></app-footer-admin>