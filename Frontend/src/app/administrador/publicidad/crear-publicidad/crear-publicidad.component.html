<app-header-admin></app-header-admin>

<div class="form-container">
  <p class="breadcrumb-title">GESTIÓN DE PUBLICIDAD</p>
  <h1 class="form-main-title">Creación de Publicidad</h1>

  <form [formGroup]="publicidadForm" (ngSubmit)="onSubmit()" class="publicidad-form">
    <div class="form-grid">
      <!-- Columna Izquierda: Campos del Formulario -->
      <div class="form-fields-column">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Nombre de la publicidad</mat-label>
          <input matInput formControlName="nombre" placeholder="Ej: Publicidad Hamburguesa">
          @if (nombre?.hasError('required')) {
            <mat-error>El nombre es requerido</mat-error>
          }
          @if (nombre?.hasError('maxlength')) {
            <mat-error>El nombre no puede tener más de 100 caracteres</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Descripción</mat-label>
          <textarea matInput formControlName="descripcion" placeholder="Ej: Publicidad en patrocinio con..." rows="3"></textarea>
          @if (descripcion?.hasError('maxlength')) {
            <mat-error>La descripción no puede tener más de 500 caracteres</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Tipo de publicidad</mat-label>
          <mat-select formControlName="tipoPublicidad" required>
            <mat-option value="banner">Banner</mat-option>
            <mat-option value="video">Video</mat-option>
            <mat-option value="popup">Popup</mat-option>
          </mat-select>
          @if (tipoPublicidad?.hasError('required')) {
            <mat-error>El tipo de publicidad es requerido</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Fecha inicial</mat-label>
          <input matInput [matDatepicker]="pickerInicio" formControlName="fechaInicial" placeholder="dd/mm/aaaa" required>
          <mat-datepicker-toggle matSuffix [for]="pickerInicio"></mat-datepicker-toggle>
          <mat-datepicker #pickerInicio></mat-datepicker>
          @if (fechaInicial?.hasError('required')) {
            <mat-error>La fecha inicial es requerida</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Fecha Final</mat-label>
          <input matInput [matDatepicker]="pickerFin" formControlName="fechaFinal" placeholder="dd/mm/aaaa" required>
          <mat-datepicker-toggle matSuffix [for]="pickerFin"></mat-datepicker-toggle>
          <mat-datepicker #pickerFin></mat-datepicker>
          @if (fechaFinal?.hasError('required')) {
            <mat-error>La fecha final es requerida</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Estado</mat-label>
          <mat-select formControlName="estado" required>
            @if (loadingEstados) {
              <mat-option disabled>Cargando estados...</mat-option>
            } @else {
              @for (estado of estados; track estado.id) {
                <mat-option [value]="estado.id">
                  {{ estado.nombre }}
                </mat-option>
              }
            }
          </mat-select>
          @if (estado?.hasError('required')) {
            <mat-error>El estado es requerido</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- Columna Derecha: Carga de Media y Configuración Adicional -->
      <div class="media-config-column">
        <p class="image-upload-label">Publicidad (Video o Imagen)</p>
        <p class="media-dimensions-label">Dimensiones recomendadas: Pendiente por definir | Tamaño máximo: 50MB</p>
        <div class="image-upload-container">
          <input hidden type="file" #fileInput (change)="onFileSelected($event)" accept="image/png, image/jpeg, image/gif, video/mp4, video/webm, video/ogg">
          @if (!mediaPreview) {
            <div class="upload-placeholder" (click)="fileInput.click()">
              <mat-icon class="upload-placeholder-icon">cloud_upload</mat-icon>
              <p>Arrastra o haz clic para subir</p>
              <p class="upload-subtitle">Imágenes: PNG, JPEG, GIF | Videos: MP4, WebM, OGG</p>
            </div>
          } @else {
            <div class="preview-container">
              @if (selectedMediaType === 'image') {
                <img [src]="mediaPreview" alt="Vista previa de la publicidad" class="image-preview">
              } @else if (selectedMediaType === 'video') {
                <video [src]="mediaPreview" class="video-preview" controls muted>
                  Tu navegador no soporta el elemento video.
                </video>
              }
              <div class="media-info">
                <p class="filename-preview">{{ selectedFileName }}</p>
                <p class="media-type-indicator">Tipo: {{ selectedMediaType === 'image' ? 'Imagen' : 'Video' }}</p>
                @if (selectedMediaType === 'video' && videoDuration) {
                  <p class="video-duration-indicator">Duración: {{ formatDuration(videoDuration) }}</p>
                }
              </div>
            </div>
          }
        </div>
        <div class="image-buttons-container">
          <button type="button" mat-stroked-button color="primary" (click)="fileInput.click()" class="image-action-button">
            <mat-icon>add_photo_alternate</mat-icon>
            {{ mediaPreview ? 'Cambiar Media' : 'Agregar Media' }}
          </button>
          @if (mediaPreview) {
            <button type="button" mat-stroked-button color="warn" (click)="eliminarMedia()" class="image-action-button">
              <mat-icon>delete</mat-icon>
              Eliminar
            </button>
          }
        </div>

        @if (selectedMediaType === 'image') {
          <div class="tiempo-intervalo-section">
            <p class="form-field-sublabel">Tiempo de intervalo (para imágenes)</p>
            <div class="tiempo-intervalo-group">
              <mat-form-field appearance="outline" class="form-field tiempo-valor">
                <mat-label>Valor</mat-label>
                <input matInput type="number" formControlName="tiempoIntervaloValor" placeholder="5" min="1">
                @if (tiempoIntervaloValor?.hasError('required')) {
                  <mat-error>El valor es requerido</mat-error>
                }
                @if (tiempoIntervaloValor?.hasError('min')) {
                  <mat-error>El valor debe ser mayor a 0</mat-error>
                }
              </mat-form-field>
              <mat-form-field appearance="outline" class="form-field tiempo-unidad">
                <mat-label>Unidad</mat-label>
                <mat-select formControlName="tiempoIntervaloUnidad">
                  <mat-option value="segundos">Segundos</mat-option>
                  <mat-option value="minutos">Minutos</mat-option>
                  <mat-option value="horas">Horas</mat-option>
                </mat-select>
                @if (tiempoIntervaloUnidad?.hasError('required')) {
                  <mat-error>La unidad es requerida</mat-error>
                }
              </mat-form-field>
            </div>
          </div>
        }
      </div>
    </div>

    <div class="form-actions">
      <button type="button" mat-stroked-button color="primary" (click)="onCancel()" class="action-button cancel-button" [disabled]="isLoading">
        <mat-icon>cancel</mat-icon>
        Cancelar
      </button>
      <button type="submit" mat-flat-button color="primary" class="action-button save-button" [disabled]="publicidadForm.invalid || isLoading || !selectedFile">
        @if (isLoading) {
          <mat-spinner diameter="20" style="margin-right: 8px;"></mat-spinner>
        } @else {
          <mat-icon>save</mat-icon>
        }
        {{ isLoading ? 'Guardando...' : 'Guardar Publicidad' }}
      </button>
    </div>
  </form>
</div>

<app-footer-admin [backRoute]="'/administrador/gestion-publicidad'"></app-footer-admin>