<app-header-admin></app-header-admin>

<div class="establecimiento-container">
  <p class="breadcrumb-title">GESTI칍N DE ESTABLECIMIENTOS</p>
  <h1 class="section-title">Creaci칩n de nuevo Establecimiento</h1>

  <form [formGroup]="form" class="form-container">
    <!-- Formulario de creaci칩n -->
    <div class="form-section">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Nombre del establecimiento</mat-label>
        <input matInput placeholder="Cheese Burger" formControlName="nombreEstablecimiento" />
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Tipo de establecimiento</mat-label>
        <input matInput placeholder="Ej: Restaurante, Cafeter칤a, etc." formControlName="tipoEstablecimiento" />
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Direcci칩n espec칤fica</mat-label>
        <textarea matInput
                  placeholder="Ej: 9 de Octubre y Malec칩n 2000, Local 15"
                  formControlName="direccionEspecifica"
                  rows="2"></textarea>
        <mat-error *ngIf="form.get('direccionEspecifica')?.hasError('required') && form.get('direccionEspecifica')?.touched">
          La direcci칩n espec칤fica es requerida
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Tel칠fono de contacto</mat-label>
        <input matInput placeholder="0999999999" formControlName="telefonoContacto" />
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Correo electr칩nico</mat-label>
        <input matInput placeholder="ejemplo@correo.com" type="email" formControlName="correoElectronico" />
      </mat-form-field>

      <!-- Responsable asignado como select -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Responsable asignado</mat-label>
        <mat-select formControlName="responsableAsignado"
                    placeholder="Seleccione un empleado"
                    [disabled]="loadingEmpleados"
                    (selectionChange)="onResponsableChange($event)">

          <!-- Mostrar loading mientras carga -->
          <mat-option *ngIf="loadingEmpleados" disabled>
            Cargando empleados...
          </mat-option>

          <!-- 游꿢 Solo mostrar el nombre completo, SIN el cargo -->
          <mat-option *ngFor="let empleado of empleadosDisponibles" [value]="empleado.id">
            {{ empleado.nombre_completo }}
          </mat-option>

          <!-- Mensaje si no hay empleados -->
          <mat-option *ngIf="!loadingEmpleados && empleadosDisponibles.length === 0" disabled>
            No hay empleados disponibles
          </mat-option>
        </mat-select>

        <!-- Error si es requerido -->
        <mat-error *ngIf="form.get('responsableAsignado')?.hasError('required') && form.get('responsableAsignado')?.touched">
          Debe seleccionar un responsable
        </mat-error>
      </mat-form-field>

      <!-- Cargo asignado como input readonly -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Cargo asignado</mat-label>
        <input matInput
               placeholder="Se asignar치 autom치ticamente"
               formControlName="cargoAsignado"
               readonly />
        <mat-hint>Este campo se completa autom치ticamente al seleccionar un responsable</mat-hint>
      </mat-form-field>

      <!-- Provincia -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Provincia</mat-label>
        <mat-select formControlName="provincia"
                    (selectionChange)="onProvinciaChange($event)"
                    placeholder="Seleccione provincia">
          <mat-option value="Guayas">Guayas</mat-option>
          <mat-option value="Pichincha">Pichincha</mat-option>
          <mat-option value="Manab칤">Manab칤</mat-option>
          <mat-option value="Esmeraldas">Esmeraldas</mat-option>
          <mat-option value="El Oro">El Oro</mat-option>
          <mat-option value="Los R칤os">Los R칤os</mat-option>
          <mat-option value="Azuay">Azuay</mat-option>
          <mat-option value="Loja">Loja</mat-option>
          <mat-option value="Tungurahua">Tungurahua</mat-option>
          <mat-option value="Imbabura">Imbabura</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Ciudad -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Ciudad</mat-label>
        <mat-select formControlName="ciudad"
                    [disabled]="!ciudadesDisponibles.length"
                    placeholder="Primero seleccione una provincia">
          <mat-option *ngFor="let ciudad of ciudadesDisponibles" [value]="ciudad">
            {{ ciudad }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Secci칩n del mapa y estado -->
    <div class="mapa-section">
      <h3>Mapa del establecimiento</h3>

      <div class="mapa-container">
        <div class="mapa-placeholder" [class.has-image]="imagenMapaUrl">
          <!-- Vista previa del mapa DENTRO del placeholder -->
          <div class="mapa-preview" *ngIf="imagenMapaUrl">
            <img [src]="imagenMapaUrl" alt="Mapa del establecimiento" />
            <button type="button" class="remove-image-button" (click)="eliminarMapa()">
              <mat-icon>close</mat-icon>
            </button>
          </div>

          <!-- Contenido original solo se muestra si NO hay imagen -->
          <div class="upload-content" *ngIf="!imagenMapaUrl">
            <div class="upload-icon">
              <mat-icon>add_location</mat-icon>
            </div>
            <p class="upload-text">Subir Ubicaci칩n</p>
            <input type="file" (change)="onMapaSeleccionado($event)" accept="image/*" style="display: none;" #fileInput>
            <button type="button" class="upload-button" (click)="fileInput.click()">
              Seleccionar archivo
            </button>
          </div>
        </div>

        <!-- Bot칩n eliminar imagen (debajo del rect치ngulo) -->
        <button type="button" class="eliminar-button" (click)="eliminarMapa()" *ngIf="imagenMapaUrl">
          Eliminar
        </button>

        <div class="estado-section">
          <h3>Estado del Establecimiento</h3>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Estado</mat-label>
            <mat-select formControlName="estadoEstablecimiento">
              <mat-option value="activo">Activo</mat-option>
              <mat-option value="inactivo">Inactivo</mat-option>
              <mat-option value="mantenimiento">En Mantenimiento</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>
    </div>
  </form>

  <!-- Botones de acci칩n -->
  <div class="form-actions">
    <button type="button" class="primary__button" (click)="crearEstablecimiento()">Crear</button>
  </div>
</div>

<app-footer-admin></app-footer-admin>
