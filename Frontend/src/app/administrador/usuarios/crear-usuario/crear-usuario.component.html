<app-header-admin></app-header-admin>

<div class="crear-usuario-container">
  <p class="breadcrumb">GESTI√ìN DE USUARIOS</p>
  <h1 class="section-title">{{ isEditMode ? 'Editar Usuario' : 'Crear Nuevo Usuario' }}</h1>

  <form [formGroup]="usuarioForm" (ngSubmit)="onSubmit()" class="user-form">
    <div class="form-layout">
      <!-- Parte izquierda: Campos del formulario -->
      <div class="form-fields">
        
        <!-- üÜï Secci√≥n: Informaci√≥n Personal -->
        <div class="form-section">
          <h3 class="section-subtitle">
            <mat-icon>person</mat-icon>
            Informaci√≥n Personal
          </h3>
          
          <div class="form-grid">
            <!-- C√©dula -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>C√©dula</mat-label>
              <input matInput formControlName="cedula" placeholder="1234567890" maxlength="10">
              <mat-error *ngIf="usuarioForm.get('cedula')?.hasError('required')">
                La c√©dula es requerida.
              </mat-error>
              <mat-error *ngIf="usuarioForm.get('cedula')?.hasError('pattern')">
                La c√©dula debe tener 10 d√≠gitos.
              </mat-error>
              <mat-error *ngIf="usuarioForm.get('cedula')?.hasError('cedulaInvalida')">
                C√©dula ecuatoriana inv√°lida.
              </mat-error>
            </mat-form-field>

            <!-- Nombres -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Nombres</mat-label>
              <input matInput formControlName="nombres" placeholder="Ej: Juan Carlos">
              <mat-error *ngIf="usuarioForm.get('nombres')?.hasError('required')">
                Los nombres son requeridos.
              </mat-error>
            </mat-form-field>

            <!-- Apellidos -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Apellidos</mat-label>
              <input matInput formControlName="apellidos" placeholder="Ej: P√©rez Gonz√°lez">
              <mat-error *ngIf="usuarioForm.get('apellidos')?.hasError('required')">
                Los apellidos son requeridos.
              </mat-error>
            </mat-form-field>

            <!-- Fecha de Nacimiento -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Fecha de Nacimiento</mat-label>
              <input matInput [matDatepicker]="nacimientoPicker" formControlName="fechaNacimiento" placeholder="dd/mm/aaaa">
              <mat-datepicker-toggle matSuffix [for]="nacimientoPicker"></mat-datepicker-toggle>
              <mat-datepicker #nacimientoPicker></mat-datepicker>
            </mat-form-field>

            <!-- Tel√©fono -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>N√∫mero de Tel√©fono</mat-label>
              <input matInput formControlName="telefono" placeholder="0987654321" maxlength="10">
              <mat-error *ngIf="usuarioForm.get('telefono')?.hasError('pattern')">
                El tel√©fono debe tener 10 d√≠gitos.
              </mat-error>
            </mat-form-field>

            <!-- Sexo -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Sexo</mat-label>
              <mat-select formControlName="sexo">
                <mat-option value="">Seleccionar...</mat-option>
                <mat-option value="Masculino">Masculino</mat-option>
                <mat-option value="Femenino">Femenino</mat-option>
                <mat-option value="Otro">Otro</mat-option>
                <mat-option value="Prefiero no decir">Prefiero no decir</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>

        <!-- üÜï Secci√≥n: Credenciales de Acceso -->
        <div class="form-section">
          <h3 class="section-subtitle">
            <mat-icon>security</mat-icon>
            Credenciales de Acceso
          </h3>
          
          <div class="form-grid">
            <!-- Username -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Nombre de Usuario</mat-label>
              <input matInput formControlName="username" placeholder="Ej: jperez">
              <mat-error *ngIf="usuarioForm.get('username')?.hasError('required')">
                El nombre de usuario es requerido.
              </mat-error>
              <mat-error *ngIf="usuarioForm.get('username')?.hasError('minlength')">
                M√≠nimo 4 caracteres.
              </mat-error>
            </mat-form-field>

            <!-- Email -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Correo Electr√≥nico</mat-label>
              <input matInput type="email" formControlName="email" placeholder="usuario@empresa.com">
              <mat-error *ngIf="usuarioForm.get('email')?.hasError('required')">
                El correo electr√≥nico es requerido.
              </mat-error>
              <mat-error *ngIf="usuarioForm.get('email')?.hasError('email')">
                Formato de correo inv√°lido.
              </mat-error>
            </mat-form-field>

            <!-- Contrase√±a (solo en creaci√≥n) -->
            <mat-form-field appearance="outline" class="form-field" *ngIf="!isEditMode">
              <mat-label>Contrase√±a</mat-label>
              <input matInput [type]="hidePassword ? 'password' : 'text'" formControlName="password">
              <button mat-icon-button matSuffix (click)="hidePassword = !hidePassword" type="button">
                <mat-icon>{{hidePassword ? 'visibility_off' : 'visibility'}}</mat-icon>
              </button>
              <mat-error *ngIf="usuarioForm.get('password')?.hasError('required')">
                La contrase√±a es requerida.
              </mat-error>
              <mat-error *ngIf="usuarioForm.get('password')?.hasError('minlength')">
                M√≠nimo 8 caracteres.
              </mat-error>
            </mat-form-field>

            <!-- Confirmar contrase√±a (solo en creaci√≥n) -->
            <mat-form-field appearance="outline" class="form-field" *ngIf="!isEditMode">
              <mat-label>Confirmar Contrase√±a</mat-label>
              <input matInput [type]="hideConfirmPassword ? 'password' : 'text'" formControlName="confirmPassword">
              <button mat-icon-button matSuffix (click)="hideConfirmPassword = !hideConfirmPassword" type="button">
                <mat-icon>{{hideConfirmPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
              </button>
              <mat-error *ngIf="usuarioForm.get('confirmPassword')?.hasError('required')">
                Confirme la contrase√±a.
              </mat-error>
              <mat-error *ngIf="usuarioForm.get('confirmPassword')?.hasError('passwordMismatch')">
                Las contrase√±as no coinciden.
              </mat-error>
            </mat-form-field>
          </div>
        </div>

        <!-- üÜï Secci√≥n: Informaci√≥n Laboral -->
        <div class="form-section">
          <h3 class="section-subtitle">
            <mat-icon>work</mat-icon>
            Informaci√≥n Laboral
          </h3>
          
          <div class="form-grid">
            <!-- Establecimiento -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Establecimiento Asignado</mat-label>
              <mat-select formControlName="establecimiento">
                <mat-option value="">Seleccionar...</mat-option>
                <mat-option *ngFor="let establecimiento of establecimientos" [value]="establecimiento.id">
                  {{ establecimiento.nombre }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="usuarioForm.get('establecimiento')?.hasError('required')">
                Debe seleccionar un establecimiento.
              </mat-error>
            </mat-form-field>

            <!-- Turno de Trabajo -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Turno de Trabajo</mat-label>
              <mat-select formControlName="turnoTrabajo">
                <mat-option value="">Seleccionar...</mat-option>
                <mat-option value="ma√±ana">Ma√±ana</mat-option>
                <mat-option value="tarde">Tarde</mat-option>
                <mat-option value="noche">Noche</mat-option>
              </mat-select>
            </mat-form-field>

            <!-- Roles m√∫ltiples -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Roles Asignados</mat-label>
              <mat-select formControlName="grupos" multiple>
                <mat-option *ngFor="let rol of rolesDisponibles" [value]="rol.id">
                  {{ rol.name }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="usuarioForm.get('grupos')?.hasError('required')">
                Debe asignar al menos un rol.
              </mat-error>
            </mat-form-field>

            <!-- Estado activo/inactivo -->
            <div class="form-field estado-field">
              <mat-slide-toggle formControlName="isActive" color="primary">
                <span class="toggle-label">Usuario Activo</span>
              </mat-slide-toggle>
              <div class="field-hint">Determina si el usuario puede acceder al sistema</div>
            </div>
          </div>
        </div>

        <!-- üéØ Botones de acci√≥n -->
        <div class="actions-section">
          <button type="button" class="cancel__button" (click)="cancelar()">
            Cancelar
          </button>
          
          <button type="submit" class="primary__button" [disabled]="usuarioForm.invalid || saving">
            <span *ngIf="!saving">{{ isEditMode ? 'Actualizar Usuario' : 'Crear Usuario' }}</span>
            <span *ngIf="saving">{{ isEditMode ? 'Actualizando...' : 'Creando...' }}</span>
          </button>
        </div>
      </div>

      <!-- Parte derecha: Imagen -->
      <div class="image-container">
        <img src="assets/admin/ADMIN_6.png" alt="Imagen de usuario" class="user-image">
      </div>
    </div>
  </form>
</div>

<app-footer-admin [backRoute]="'/administrador/usuarios'"></app-footer-admin>